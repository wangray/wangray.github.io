<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Matasano Crypto Challenges, Set 3 | Tack, Hunt, Pool</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  <meta name="keywords" content="cryptopals" />
  
  
  <meta name="description" content="Challenge 17 The CBC padding oracle!!! The CBC padding oracle is a very famous attack. We have an oracle function that takes in a ciphertext and decrypts it, returning True if the plaintext is padded">
<meta property="og:type" content="article">
<meta property="og:title" content="Matasano Crypto Challenges, Set 3">
<meta property="og:url" content="http://raywang.tech/2017/03/07/set3-writeup/index.html">
<meta property="og:site_name" content="Tack, Hunt, Pool">
<meta property="og:description" content="Challenge 17 The CBC padding oracle!!! The CBC padding oracle is a very famous attack. We have an oracle function that takes in a ciphertext and decrypts it, returning True if the plaintext is padded">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://upload.wikimedia.org/wikipedia/commons/3/3f/Ctr_encryption.png">
<meta property="og:image" content="https://upload.wikimedia.org/wikipedia/commons/3/34/Ctr_decryption.png">
<meta property="og:image" content="https://upload.wikimedia.org/wikipedia/commons/b/b5/Mersenne_Twister_visualisation.svg">
<meta property="og:image" content="https://wikimedia.org/api/rest_v1/media/math/render/svg/c1448dcf56263ba3a393fad35ef06fbd1618df04">
<meta property="article:published_time" content="2017-03-07T18:38:11.000Z">
<meta property="article:modified_time" content="2024-08-29T06:03:14.441Z">
<meta property="article:author" content="Ray Wang">
<meta property="article:tag" content="cryptopals">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://upload.wikimedia.org/wikipedia/commons/3/3f/Ctr_encryption.png">
  
    <link rel="alternate" href="/atom.xml" title="Tack, Hunt, Pool" type="application/atom+xml">
  
  <link rel="icon" href="/css/images/favicon.ico">
  <!-- <link href="https://fonts.googleapis.com/css?family=Droid+Sans:400,700|Ubuntu+Mono:400" rel="stylesheet"> -->
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0/katex.min.css" rel="stylesheet">

  
<link rel="stylesheet" href="/css/style.css">


  
<script src="/js/jquery-3.1.1.min.js"></script>


  
  
<script src="/libs/justifiedgallery/jquery.justifiedGallery.min.js"></script>

  
<link rel="stylesheet" href="/libs/justifiedgallery/justifiedGallery.min.css">




  <!-- Bootstrap core CSS -->
  <link rel="stylesheet" href="/css/bootstrap.css" >

  
    
<link rel="stylesheet" href="/css/dialog.css">

  

  
    <link rel="stylesheet" href="/css/header-post.css" >
  

  

<meta name="generator" content="Hexo 7.1.1"></head>

<body>
  
  <div id="container">
    <div id="wrap">
      
        <header>

    <div id="allheader" class="navbar navbar-default navbar-static-top" role="navigation">
        <div class="navbar-inner">

          <div class="container">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
              <span class="sr-only">Toggle navigation</span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>

            <div class="navbar-collapse collapse">
              <ul class="nav navbar-nav">
                
                  <li> <a class="main-nav-link" href="/">Home</a> </li>
                
                  <li> <a class="main-nav-link" href="/archives">Archives</a> </li>
                
                  <li> <a class="main-nav-link" href="/categories">Categories</a> </li>
                
                  <li> <a class="main-nav-link" href="/tags">Tags</a> </li>
                
                  <li> <a class="main-nav-link" href="/about">About</a> </li>
                
                  <li><div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="" />
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="Type something..." />
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: 'Posts',
            PAGES: 'Pages',
            CATEGORIES: 'Categories',
            TAGS: 'Tags',
            UNTITLED: '(Untitled)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>

<script src="/js/insight.js"></script>



</div>
</li>
            </div>
          </div>

      </div>
    </div>

</header>



      

      <div id="content" class="outer">
        
          <section id="main" style="float:none;"><article id="post-set3-writeup"
  
  style="width: 75%; float:left;"
  class="article article-type-post" itemscope itemprop="blogPost" >
  <!-- Back button -->
  
  <a href="javascript:history.go(-1)" class="back-button-link"><span class="back-button-icon"></span> Back</a>
  

  <div id="articleInner" class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" class="article-title" itemprop="name">
      Matasano Crypto Challenges, Set 3
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2017/03/07/set3-writeup/" class="article-date">
	  <time datetime="2017-03-07T18:38:11.000Z" itemprop="datePublished">03-07-2017</time>
	</a>

      
    <a class="article-category-link" href="/categories/Crypto/">Crypto</a>

    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><h2 id="challenge-17-the-cbc-padding-oracle"><a class="markdownIt-Anchor" href="#challenge-17-the-cbc-padding-oracle"></a> Challenge 17 The CBC padding oracle!!!</h2>
<p>The CBC padding oracle is a very famous attack. We have an oracle function that takes in a ciphertext and decrypts it, returning <code>True</code> if the plaintext is padded properly.</p>
<p>The process behind the attack on each block is:</p>
<p><escape><span id="more"></span></escape></p>
<ol>
<li>For each byte, starting at the last position, modify the ciphertext in the previous block, cycling through all 256 possibilities for the plaintext until I find the correct one. Here’s the explanation of how I make and check my guesses.</li>
</ol>
<p>For the currently examined block, remember that I can modify the previous block’s ciphertext, which will be XORed with this block’s intermediate state to get a modified plaintext. What is the goal for the modified plaintext? It’s to get the proper padding bytes at the end of it!</p>
<p>So, to decrypt the last byte of the block, I first provide the correct offset</p>
  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">new_ciphertext, C<span class="string">&#x27;:</span></span><br><span class="line"><span class="string">block -2                -1</span></span><br><span class="line"><span class="string">AAAAAAAAAAAAAAAZ XXXXXXXXXXXXXXXU</span></span><br></pre></td></tr></table></figure>
<p>If I cleverly choose the value of Z, then the last byte of C’, <code>U</code> above, will XOR to the correct padding byte, <code>\x01</code>.</p>
<p>I XOR out the corresponding byte from the ciphertext, XOR out a guess for the flag byte character, and XOR in the desired padding byte (<code>\x01</code>).</p>
  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pad_str = offset_pad + xor(prev_block[-desired_padding_byte], cand_ord, desired_padding_byte)</span><br></pre></td></tr></table></figure>
<p>I create the <code>new_ciphertext C'</code> by inserting my crafted block <code>C[-2]'</code> before the block I’m currently examining.</p>
  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">new_ciphertext = ciphertext[:-<span class="number">32</span>] + pad_str + ciphertext[-<span class="number">16</span>:]</span><br></pre></td></tr></table></figure>
<p>If my guess is correct, then only <code>\x01</code> will be left, and <code>padding_oracle(new_ciphertext)</code> will return <code>True</code>.</p>
<ol start="2">
<li>If I’m not examining the last character in the block, then the desired padding bytes will be something greater than <code>\x01</code>. I modify the following ciphertext bytes I’ve already solved to XOR out the ciphertext byte, XOR out the <strong>known</strong> flag bytes, and XOR in the desired padding byte (<code>\x02 - \xF</code>).</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pad_str = pad_str + xor(prev_block[-desired_padding_byte+<span class="number">1</span>:], known_last_bytes, desired_padding_byte) <span class="keyword">if</span> <span class="built_in">len</span>(known_last_bytes) &gt; <span class="number">0</span> <span class="keyword">else</span> pad_str</span><br></pre></td></tr></table></figure>
<p>As before, the correct guess will cause the byte of interest to XOR to the proper padding byte, and <code>padding_oracle(new_ciphertext)</code> will return <code>True</code>.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">new_ciphertext, C<span class="string">&#x27;:</span></span><br><span class="line"><span class="string">block -2                -1</span></span><br><span class="line"><span class="string">AAAAAAAAAAAAAAZK XXXXXXXXXXXXXXUK</span></span><br></pre></td></tr></table></figure>
<p>Above, I want the plaintext bytes at positions <code>UK</code> to decrypt to <code>\x02\x02</code>. Modifying <code>K</code> to decrypt to <code>\x02</code> is simple because I already know the byte and can fully control what to XOR in or out.</p>
<p><em>Note:</em> The ‘previous ciphertext’ block for the first block is the IV, so we perform the XORs on it the same way we would modify any other block.</p>
<p>The wrapper function, <code>padding_oracle_attack(padding_oracle, ciphertext, blocksize)</code>, will loop through calls to <code>decipher_block</code> to find the last block, append the found bytes to the flag, and on the next iteration, slice out the blocks of ciphertext I’ve already solved.</p>
<h2 id="challenge-18"><a class="markdownIt-Anchor" href="#challenge-18"></a> Challenge 18</h2>
<p>This challenge is to implement CTR (Counter) stream cipher mode. CTR mode does not encrypt the plaintext — rather, it encrypts a running stream of counter bytes, which is then XORed with the plaintext.</p>
<p>One benefit of CTR mode is that it does not require padding.</p>
<p><img src="https://upload.wikimedia.org/wikipedia/commons/3/3f/Ctr_encryption.png" alt="CTR encryption" /></p>
<p><img src="https://upload.wikimedia.org/wikipedia/commons/3/34/Ctr_decryption.png" alt="CTR Decryption" /></p>
<p>I define a <code>CTR()</code> class in <code>set3_utils</code>. Decryption is identical to encryption. In <code>encrypt</code>, I generate the keystream, in 128 byte chunks, for all of my plaintext, which looks like</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">keyblock = e.update(p64(self.nonce, <span class="string">&#x27;little&#x27;</span>) + p64(self.counter, <span class="string">&#x27;little&#x27;</span>))</span><br><span class="line">keystream += keyblock</span><br></pre></td></tr></table></figure>
<p>These are pwntools packing functions, packing the counter in little-endian format. The nonce is a random, secret value that composes the first 64 bytes of every keystream block.</p>
<p>After XORing my keystream with the plaintext, I save the unused keystream bytes in <code>self.carry_over_bytes</code>. The next time I run <code>decrypt()</code> or <code>encrypt()</code>, I set <code>keystream = self.carry_over_bytes</code> so I use all the bytes of previously-generated keystreams.</p>
<h2 id="challenge-19-break-fixed-nonce-ctr-mode-using-substitutions"><a class="markdownIt-Anchor" href="#challenge-19-break-fixed-nonce-ctr-mode-using-substitutions"></a> Challenge 19 Break fixed-nonce CTR mode using substitutions</h2>
<h2 id="challenge-20-break-fixed-nonce-ctr-statistically"><a class="markdownIt-Anchor" href="#challenge-20-break-fixed-nonce-ctr-statistically"></a> Challenge 20 Break fixed-nonce CTR statistically</h2>
<p>In this challenge, using a fixed-nonce for CTR will essentially boil down to solving repeating-key XOR, where the repeating-key is the reused ciphertext of the CTR keystream.</p>
<p>I know that each encrypted text has been XORed with the same keystream. I first pad each encrypted text with 0’s to the same length (anything longer than the longest line).</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">padded_encrypted_texts = [text.ljust(max_length, <span class="string">&#x27;0&#x27;</span>) <span class="keyword">for</span> text <span class="keyword">in</span> encrypted_texts]</span><br></pre></td></tr></table></figure>
<p>Then, I can simply concatenate all the ciphertexts into one long string, as if a repeating-xor-key of length max_length had been applied.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">keystream = breakRepeatingXor(<span class="string">&quot;&quot;</span>.join(padded_encrypted_texts), max_length)</span><br></pre></td></tr></table></figure>
<p>The result will be a keystream that, when XORed with each encrypted text, should produce mostly readable text. The accuracy towards the end of the longer strings will degrade, because there is not enough information to determine the correct key — there are simply not enough strings near the maximum length to determine the key based on letter frequency.</p>
<h2 id="challenge-21-implement-the-mt19937-mersenne-twister-rng"><a class="markdownIt-Anchor" href="#challenge-21-implement-the-mt19937-mersenne-twister-rng"></a> Challenge 21 Implement the MT19937 Mersenne Twister RNG</h2>
<p>The Mersenne Twister is by far the most common PRNG (pseudo-random number generator). The most common version is based on the Mersenne prime 2<sup>19937</sup>−1, and has a known set of constants and magic values.</p>
<p><img src="https://upload.wikimedia.org/wikipedia/commons/b/b5/Mersenne_Twister_visualisation.svg" alt="Mersenne visualization" /></p>
<p>There are three main components of MT19937, 32-bit values.</p>
<ol>
<li>Initialization of the first set of 624 values from a seed</li>
<li>Outputting the next number from the RNG, after some tempering</li>
<li>Generating a new set of 624 values (twisting)</li>
</ol>
<p>In step 1, we initialize the <code>self.state</code> array by setting the first value to be the seed, and then calculating the rest from the formula off Wikipedia, <code>x[i] = f × (x[i-1] ⊕ (x[i-1] &gt;&gt; (w-2))) + i</code>, where w is the word size, 32 bits.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">1</span>, <span class="number">624</span>):</span><br><span class="line">	self.state[i] =  self.int32(f * (self.state[i-<span class="number">1</span>] ^ (self.state[i-<span class="number">1</span>] &gt;&gt; <span class="number">30</span>)) + i)</span><br></pre></td></tr></table></figure>
<p>where <code>f</code> is a magic, <code>1812433253</code>.</p>
<p>In step 2, the RNG outputs a number by taking the next state value, indexed by <code>self.index</code>, and applying some temper transforms before returning it. Then, we increment <code>self.index</code> to use the next state value next time.</p>
<p>When we have used up 624 values, we “twist” to generate more.</p>
<p><img src="https://wikimedia.org/api/rest_v1/media/math/render/svg/c1448dcf56263ba3a393fad35ef06fbd1618df04" alt="Mersenne twist" /></p>
<p>For each state value, the RNG concats the MSB of the current state value and the other 31 bits from the next state value.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">y = (self.state[i] &amp; <span class="number">0x80000000</span>) + (self.state[(i+<span class="number">1</span>) % <span class="number">624</span>] &amp; <span class="number">0x7fffffff</span>)</span><br></pre></td></tr></table></figure>
<p>Then it does the A transform above: right-shifts by one, and XORing an additional magic if the current state value is odd.  We also XOR with the 397th-next former state variable.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">self.state[i] = self.state[(i+<span class="number">397</span>) % <span class="number">624</span>] ^ (y&gt;&gt;<span class="number">1</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> y % <span class="number">2</span> != <span class="number">0</span>:</span><br><span class="line">  <span class="comment"># if odd, xor with another magic number</span></span><br><span class="line">  self.state[i] ^= <span class="number">0x9908b0df</span></span><br></pre></td></tr></table></figure>
<h2 id="challenge-22-crack-an-mt19937-seed"><a class="markdownIt-Anchor" href="#challenge-22-crack-an-mt19937-seed"></a> Challenge 22 Crack an MT19937 seed</h2>
<h2 id="challenge-23-clone-an-mt19937-rng-from-its-output"><a class="markdownIt-Anchor" href="#challenge-23-clone-an-mt19937-rng-from-its-output"></a> Challenge 23 Clone an MT19937 RNG from its output</h2>
<p>TO clone an MT19937 RNG, we need to find its 624-value internal state. We need to get 624 RNG outputs, and untemper each one.</p>
<p>The untempering is very tricky — remember that we did this sequence of two right shifts and two left-shift ANDs:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">temp ^= (temp &gt;&gt; <span class="number">11</span>)</span><br><span class="line">temp ^= (temp &lt;&lt; <span class="number">7</span>) &amp; <span class="number">2636928640</span></span><br><span class="line">temp ^= (temp &lt;&lt; <span class="number">15</span>) &amp; <span class="number">4022730752</span></span><br><span class="line">temp ^= (temp &gt;&gt; <span class="number">18</span>)</span><br></pre></td></tr></table></figure>
<p>Let’s see how to undo that right shift:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">10110111010111110001000011001110</span> ^</span><br><span class="line"><span class="number">000000000000000000</span>10110111010111 (&gt;&gt;<span class="number">18</span>)</span><br><span class="line">=</span><br><span class="line"><span class="number">10110111010111110011110100011001</span></span><br></pre></td></tr></table></figure>
<p>We iterate through all the bits of the output, starting from the leftmost bit</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">32</span>):</span><br><span class="line">  output_bit = getBit(binary_str, i)</span><br><span class="line"></span><br><span class="line">  recovered_bit = output_bit ^ getBit(orig_bits, i - shift)</span><br><span class="line">  <span class="comment"># set the bit at index i in the orig_bits to be the recovered bit</span></span><br><span class="line">  orig_bits = setBit(orig_bits, i, recovered_bit)</span><br></pre></td></tr></table></figure>
<p>While <code>i &lt; shift</code>, getBit() will return 0 as the XOR bit, and <code>recovered_bit</code> will just be the same as the output bit. When <code>i = shift</code>, <code>orig_bits</code> will contain the first <code>shift</code> original bits. <code>getBit(orig_bits, i - shift)</code> will emulate the right-shifted original value, grabbing original bit values, starting from the left of <code>orig_bits</code>. Thus, the XOR of the <code>output_bit</code> and the corresponding index of <code>orig_bits</code> will recover the next original bit.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">When i = <span class="number">18</span></span><br><span class="line"></span><br><span class="line">output:</span><br><span class="line"></span><br><span class="line">              18___</span><br><span class="line">                  |</span><br><span class="line"><span class="number">10110111010111110011110100011001</span></span><br><span class="line"></span><br><span class="line">orig_bits:</span><br><span class="line"><span class="number">101101110101111100</span></span><br><span class="line"></span><br><span class="line">recovered_bit:</span><br><span class="line">output[<span class="number">18</span>] ^ orig_bits[<span class="number">0</span>]</span><br><span class="line">    <span class="number">1</span>      ^    <span class="number">1</span>         = <span class="number">0</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>Note that, if <code>shift &lt; 16</code>, at some point each recovered original bit is used immediately in the next iteration of the for loop to recover the next bit.</p>
<p>To untemper the left shift + and + xor, we reconstruct the original from the right side, not the left.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">                    24---</span><br><span class="line">                        |</span><br><span class="line">                        \/      </span><br><span class="line">1011011101011111000100001 1001110 ^ (&lt;--orig_bits)</span><br><span class="line">1010111110001000011001110 0000000 (&lt;&lt; 7) =</span><br><span class="line">__________________________________</span><br><span class="line">0001100011010111011101111 1001110 &amp;</span><br><span class="line">1001110100101100010101101 0000000 (&lt;--2636928640 magic) =</span><br><span class="line">__________________________________</span><br><span class="line">0001100000000100010101101 0000000 output_bits</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">reversed</span>(xrange(<span class="number">32</span>)):</span><br><span class="line">  output_bit = getBit(binary_str, i)</span><br><span class="line"></span><br><span class="line">  undo_xor_bit = getBit(orig_bits, i + shift) &amp; getBit(and_val, i)</span><br><span class="line">  recovered_bit = output_bit ^ undo_xor_bit</span><br><span class="line">  orig_bits = setBit(orig_bits, i, recovered_bit)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>While <code>i + shift &gt; 31</code>, the <code>undo_xor_bit</code> is <code>0</code>, so the last <code>shift</code> bits of <code>orig_bits</code> are identical to the last <code>shift</code> output_bits.</p>
<p>Once <code>i &lt;= 31-shift</code>, we begin using values from the right side of <code>orig_bits</code>, emulating the left-shifted value. We then &amp; in the magic bit, and XOR with the output bit to recover the next original bit.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">When i = <span class="number">24</span></span><br><span class="line"></span><br><span class="line">undo_xor_bit:</span><br><span class="line">orig_bits[<span class="number">31</span>] &amp; and_value[<span class="number">24</span>]</span><br><span class="line">      <span class="number">0</span>              <span class="number">1</span>       = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">recovered_bit:</span><br><span class="line">output[<span class="number">24</span>] ^ undo_xor_bit =</span><br><span class="line">    <span class="number">1</span>      ^     <span class="number">0</span>        =  <span class="number">1</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>Our final <code>untemper</code> function is just reversing the 4 tempers,</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">untemper</span>(<span class="params">val</span>):</span><br><span class="line">	val = unRightShiftXor(val, <span class="number">18</span>)</span><br><span class="line"></span><br><span class="line">	val = unLeftShiftXorAnd(val, <span class="number">15</span>, <span class="number">4022730752</span>)</span><br><span class="line"></span><br><span class="line">	val = unLeftShiftXorAnd(val, <span class="number">7</span>, <span class="number">2636928640</span>)</span><br><span class="line"></span><br><span class="line">	val = unRightShiftXor(val, <span class="number">11</span>)</span><br></pre></td></tr></table></figure>
<p>and we can easily clone an RNG’s 624-value state:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">624</span>):</span><br><span class="line">	rand = mt.get_number()</span><br><span class="line">	cloned_mt_state[i] = untemper(rand)</span><br></pre></td></tr></table></figure>
<p>We check that a MT with the cloned state does in fact generate the same numbers as the original MT. Done!</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cloned_mt = MT19937(arbitrary value)</span><br><span class="line">cloned_mt.state = cloned_mt_state</span><br></pre></td></tr></table></figure>
<h2 id="challenge-24-create-the-mt19937-stream-cipher-and-break-it"><a class="markdownIt-Anchor" href="#challenge-24-create-the-mt19937-stream-cipher-and-break-it"></a> Challenge 24 Create the MT19937 stream cipher and break it</h2>
<p>We first need to create an  MT19937 stream cipher, which operates much like CTR mode. The keystream, the RNG output, is simply XORed to decrypt or encrypt.</p>
<p>We have an oracle that appends some random prefix to our plaintext before encrypting it using the MTR Stream cipher.</p>
<p>We first find the prefix length, by simply subtracting the length of the plaintext from the len of oracle-returned ciphertext — the added length in the ciphertext must be due to the prefix, since there’s no padding in a stream cipher.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Step <span class="number">1</span>:</span><br><span class="line">plaintext:</span><br><span class="line">AAAAAAAAAAAAAA</span><br><span class="line"></span><br><span class="line">encrypted <span class="keyword">in</span> oracle:</span><br><span class="line">|rand_prefix|</span><br><span class="line">|    |</span><br><span class="line">RRRRRR AAAAAAAAAAAAAA</span><br><span class="line">|<span class="built_in">len</span>(oracle_ciphertext)|</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Step <span class="number">2</span>:</span><br><span class="line">padded:</span><br><span class="line">|prefix_len|</span><br><span class="line">|    |</span><br><span class="line">AAAAAA AAAAAAAAAAAAAA</span><br><span class="line">|<span class="built_in">len</span>(oracle_ciphertext)|</span><br><span class="line"></span><br><span class="line">       |-COMPARE ENC-|  </span><br></pre></td></tr></table></figure>
<p>We then iterate through all possible seed values, 1…2<sup>16</sup>. We create a MT Cipher with each seed, encrypting our <code>padded</code> data and seeing if it gives the same ciphertext as the oracle did. (Remember to slice out the random prefix when comparing!) If the ciphertexts match, we have found our seed!</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">2</span>**<span class="number">16</span>):</span><br><span class="line">  padded = <span class="string">&#x27;A&#x27;</span> * <span class="built_in">len</span>(oracle_ciphertext)</span><br><span class="line">  <span class="keyword">if</span> MT19937Cipher(i).encrypt(padded)[prefix_len:] == oracle_ciphertext[prefix_len:]:</span><br><span class="line">    <span class="keyword">return</span> i</span><br></pre></td></tr></table></figure>

      
    </div>
    
      <footer class="article-footer">
        
          
	<section id="comments" class="comment">
	  <div id="disqus_thread">
	  <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
	  </div>
	</section>

	<script type="text/javascript">
	var disqus_shortname = 'wangray';
	(function(){
	  var dsq = document.createElement('script');
	  dsq.type = 'text/javascript';
	  dsq.async = true;
	  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
	  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	}());
	(function(){
	  var dsq = document.createElement('script');
	  dsq.type = 'text/javascript';
	  dsq.async = true;
	  dsq.src = '//' + disqus_shortname + '.disqus.com/count.js';
	  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	}());
	</script>



        
        
          
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/cryptopals/" rel="tag">cryptopals</a></li></ul>

        
      </footer>
    
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2017/03/07/set1_writeup/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">
        
          Matasano Crypto Challenges, Set 1
        
      </div>
    </a>
  
  
    <a href="/2017/03/07/set4-writeup/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">Matasano Crypto Challenges, Set 4</div>
    </a>
  
</nav>


  
</article>


<!-- Table of Contents -->

  <aside id="sidebar">
    <div id="toc" class="toc-article">
    
      <strong class="toc-title">Contents</strong>
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#challenge-17-the-cbc-padding-oracle"><span class="toc-number">1.</span> <span class="toc-text"> Challenge 17 The CBC padding oracle!!!</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#challenge-18"><span class="toc-number">2.</span> <span class="toc-text"> Challenge 18</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#challenge-19-break-fixed-nonce-ctr-mode-using-substitutions"><span class="toc-number">3.</span> <span class="toc-text"> Challenge 19 Break fixed-nonce CTR mode using substitutions</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#challenge-20-break-fixed-nonce-ctr-statistically"><span class="toc-number">4.</span> <span class="toc-text"> Challenge 20 Break fixed-nonce CTR statistically</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#challenge-21-implement-the-mt19937-mersenne-twister-rng"><span class="toc-number">5.</span> <span class="toc-text"> Challenge 21 Implement the MT19937 Mersenne Twister RNG</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#challenge-22-crack-an-mt19937-seed"><span class="toc-number">6.</span> <span class="toc-text"> Challenge 22 Crack an MT19937 seed</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#challenge-23-clone-an-mt19937-rng-from-its-output"><span class="toc-number">7.</span> <span class="toc-text"> Challenge 23 Clone an MT19937 RNG from its output</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#challenge-24-create-the-mt19937-stream-cipher-and-break-it"><span class="toc-number">8.</span> <span class="toc-text"> Challenge 24 Create the MT19937 stream cipher and break it</span></a></li></ol>
    
    </div>
  </aside>

</section>
        
      </div>
      
      <footer id="footer">
  

  <div class="container">
      <div class="row">
	      <p> Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/iTimeTraveler/hexo-theme-hiker" target="_blank">Hexo-theme-hiker</a> </p>
	      <p id="copyRightEn">Copyright &copy; 2024 Ray Wang. All Rights Reserved.</p>
	</div>
  </div>
</footer>


<!-- min height -->

<script>
    var wrapdiv = document.getElementById("wrap");
    var contentdiv = document.getElementById("content");
    var allheader = document.getElementById("allheader");

    wrapdiv.style.minHeight = document.body.offsetHeight + "px";
    if (allheader != null) {
      contentdiv.style.minHeight = document.body.offsetHeight - allheader.offsetHeight - document.getElementById("footer").offsetHeight + "px";
    } else {
      contentdiv.style.minHeight = document.body.offsetHeight - document.getElementById("footer").offsetHeight + "px";
    }
</script>

    </div>
    <!-- <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="/categories" class="mobile-nav-link">Categories</a>
  
    <a href="/tags" class="mobile-nav-link">Tags</a>
  
    <a href="/about" class="mobile-nav-link">About</a>
  
</nav> -->
    


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>






  
<script src="/js/dialog.js"></script>




<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-104530975-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->



  
<script src="/libs/justifiedgallery/jquery.justifiedGallery.min.js"></script>

  
<link rel="stylesheet" href="/libs/justifiedgallery/justifiedGallery.min.css">





<script src="/js/script.js"></script>


<script src="/js/bootstrap.js"></script>


  </div>

  <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="myModalLabel">设置</h2>
      </div>
      <hr style="margin-top:0px; margin-bottom:0px; width:80%; border-top: 3px solid #000;">
      <hr style="margin-top:2px; margin-bottom:0px; width:80%; border-top: 1px solid #000;">


      <div class="modal-body">
          <div style="margin:6px;">
            <a data-toggle="collapse" data-parent="#accordion" href="#collapseOne" onclick="javascript:setFontSize();" aria-expanded="true" aria-controls="collapseOne">
              Toggle font size
            </a>
          </div>
          <div id="collapseOne" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingOne">
          <div class="panel-body">
            Toggled font size
          </div>
        </div>



          <div style="margin:6px;">
            <a data-toggle="collapse" data-parent="#accordion" href="#collapseTwo" onclick="javascript:setBackground();" aria-expanded="true" aria-controls="collapseTwo">
              Toggle night view
            </a>
        </div>
          <div id="collapseTwo" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingTwo">
          <div class="panel-body">
            Press again to switch views
          </div>
        </div>

        <div>
            <a data-toggle="collapse" data-parent="#accordion" href="#collapseThree" aria-expanded="true" aria-controls="collapseThree">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;About&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</a>
        </div>
         <div id="collapseThree" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingThree">
          <div class="panel-body">
            Tack, Hunt, Pool
          </div>
          <div class="panel-body">
            Copyright © 2024 Ray Wang All Rights Reserved.
          </div>
        </div>
      </div>


      <hr style="margin-top:0px; margin-bottom:0px; width:80%; border-top: 1px solid #000;">
      <hr style="margin-top:2px; margin-bottom:0px; width:80%; border-top: 3px solid #000;">
      <div class="modal-footer">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
      </div>
    </div>
  </div>
</div>


</body>
</html>
